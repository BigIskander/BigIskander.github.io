---
redirect_from: 
    - /strokeautocorrect
layout: post
title: "Алгоритм автокорректировки черт."
formula: "Y"
---

Здесь приводится описание программы для автокорректировки черт при рукописном вводе китайских иероглифов. Целью создания программы было улучшение точности распознавания иероглифов при рукописном вводе с помощью клавиатуры рукописного ввода. 

Ранее я создавал клавиатуру <a href="https://github.com/BigIskander/Handwriting-keyboard-for-Linux-tesseract" target="_blank">рукописного ввода для Linux</a>  (работающую оффлайн). Эта клавиатура превращает рукописный ввод (на канвасе) в изображение и отправляет это изображение в программу распознавания текста с изображения, затем показывает полученный результат. Проблема в том, что программы распознавания текста предназначены (обучены), в первую очередь, для распознавания печатного текста (с печатными шрифтами), а не текста, написанного от руки. Поэтому, при распознавании текста, написанного от руки, текст не всегда распознается корректно. Особенно это касается распознавания иероглифов. Если привести рукописный ввод надписи ближе к печатному виду, это поможет лучше распознавать рукописный текст. Для этого я и создавал эту программу, как помощь в написании иероглифов на компьютере.

Демонстрация работы программы (видео):

<p>
<video style="width:calc(min(100%,400px))" preload="auto" controls>
    <source src="/assets/images/posts/2025-strokeautocorrect/StrokeAutocorrectDemo.mp4" type='video/mp4'/>
    Your browser does not support the video tag.
</video>
</p>

Данная программа может улучшить точность распознавания иероглифов при рукописном вводе, помогая приводить их изображение ближе к печатному виду. Я добавил код программы в качестве экспериментальной функции в своё приложение для компьютра: <a href="/2023/09/05/xuexihanzi_js.html" target="_blank">программа для запоминания китайских слов</a>.

В виду большого разнообразия самих иероглифов и тем более линий (черт) применяемых в написании иероглифов, на данный момент программа учитывает не все варианты. Я планирую дорабатывать, улучшать её в будущем.

<h2 id="how_works_inside">Как программа работает изнутри.</h2>

Отдельная черта представляет собой непрерывную линию. Эта линия храниться в памяти программы, как последовательный набор точек, соединенных между собой прямыми линиями. Расположение каждой точки представлено двумя координатами X и Y. В браузере начало координат (точка (0, 0)) располагается в левом верхнем углу.

<img src="/assets/images/posts/2025-strokeautocorrect/XYgraph.jpg" class="zoomable" style="max-width:300px;" alt="XY график.">

После того, как пользователь нарисовал линию на канвасе, программа:

<ol>
<li>Выделяет квадрат, в котором находится черта, точки: Xmin, Xmax, Ymin, Ymax.</li>
<li>Трансформирует координаты каждой точки так, чтобы линия умещалась в плоскость: <em style="white-space: nowrap;">{% raw %}\(X ∈ [-1, 1]\){% endraw %};</em> <em style="white-space: nowrap;">{% raw %}\(Y ∈ [-1, 1]\){% endraw %}.</em></li>
<li>По всей длине равномерно отмечает 100 точек.</li>
<li>Сравнивает эти 100 точек с заранее посчитанными линиями (чертами) из памяти программы и из них выбирается та, что наиболее похожа на нарисованную пользователем линию. Сравнение осуществляется следующим образом.
    <p>Для каждой заранее посчитанной линии расчитывается следующая формула:
        <em style="white-space: nowrap;">
            {% raw %}
                \(S = \sum \limits_{i=1}^{100} ((X_i - \overset{\text{~}}{X_i})^2 + (Y_i - \overset{\text{~}}{Y_i})^2) \)
            {% endraw %}
        </em>.
        Где: <em style="white-space: nowrap;">{% raw %}\(X_i, Y_i\){% endraw %}</em> - координаты точки {% raw %}\(i\){% endraw %} из линнии нарисованной пользователем; <em style="white-space: nowrap;">{% raw %}\(\overset{\text{~}}{X_i}, \overset{\text{~}}{Y_i}\){% endraw %}</em> - координаты точки {% raw %}\(i\){% endraw %} из заранее посчитанной линии в памяти программы. Далее, выбирается заранее посчитанная линия из памяти программы с наименьшим значением {% raw %}\(S\){% endraw %}.
    </p>
</li>
<li>Линия, нарисованная пользователем, заменяется на заранее посчитанную линию из памяти программы.</li>
<li>Координаты точек из плоскости <em style="white-space: nowrap;">{% raw %}\(X ∈ [-1, 1]\){% endraw %};</em> <em style="white-space: nowrap;">{% raw %}\(Y ∈ [-1, 1]\){% endraw %}</em> пересчитываются обратно в изначальную систему координат.</li>
<li>Старая линия стирается, вместо неё рисуется новая исправленая линия.</li>
</ol>

<h2 id="about_development">О том, как программа разрабатывалась.</h2>

<p>
На первом этапе была разработана функция, пересчитывающая координаты линии нарисованной пользователем в плоскость 
<em style="white-space: nowrap;">{% raw %}\(X ∈ [-1, 1]\){% endraw %};</em> <em style="white-space: nowrap;">{% raw %}\(Y ∈ [-1, 1]\){% endraw %}</em>
 и затем, по всей длине линии равномерно отмечающая 100 точек.
</p>

<p>
Далее, был написан набор функций, отрисовывающих на канвасе линию нужной формы (такой же формы, как выглядит черта). Черты отрисовывались, как последовательные сочетания прямых линий и <a href="https://javascript.info/bezier-curve" target="_blank">кривых Безье</a> (построенных по 4 точкам). За основу (того, как должны выглядить черты) я взял изображения черт с сайта: <a href="https://www.archchinese.com/chinese_character_strokes.html" target="_blank">https://www.archchinese.com/chinese_character_strokes.html</a>. После того, как функция отрисует линию, эта линия пересчитывалась в плоскость <em style="white-space: nowrap;">{% raw %}\(X ∈ [-1, 1]\){% endraw %};</em> <em style="white-space: nowrap;">{% raw %}\(Y ∈ [-1, 1]\){% endraw %}</em>, на ней отмечалось 100 точек и эти данные сохранялись в отдельный файл, как заранее посчитанная линия. 
</p>

Для того, чтобы легче было подбирать параметры функций, отрисовывающих линии, была создана еще одна вспомогательная программа, где можно вручную перетаскивать отдельные точки и смотреть, как при этом отрисовывается линия.

Пример работы этих вспомогательных программ вы можете видеть на изображениях ниже.

<div class="images_row" style="background-color: rgba(200, 200, 200, 0.1);">
    <div style="margin: 5px">
        <img src="/assets/images/posts/2025-strokeautocorrect/drawStroke.png" class="zoomable" style="max-width:300px;" alt="Снимок экрана.">
    </div>
    <div style="margin: 5px">
        <img src="/assets/images/posts/2025-strokeautocorrect/curves.png" class="zoomable" style="max-width:300px;" alt="Снимок экрана.">
    </div>
</div>

<script>
    links = [
        "Начало.", "#top_of_content",
        "Как программа работает изнутри.", "#how_works_inside",
        "О том, как программа разрабатывалась.", "#about_development"
    ];
</script>
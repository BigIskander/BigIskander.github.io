---
layout: post
title: "Устройство для автоматического полива растения и сбора данных о влажности почвы."
---
Это самодельное устройство собранное из электронных компонентов. Это мой хобби проэкт. Устройство проверяет влажность почвы раз в час и если влажност ниже 20% наливает 300 мл воды в поддон растения. Так же устройство по WiFi отправляет данные о влажности почвы на MQTT сервер. Устройство работает автономно и запитывается от небольшой солнечной панели и аккумулятора.

Кому интересно, все файлы проекта я разместил в репозитории на github: 
<a href="https://github.com/BigIskander/PlantWatering/tree/main" target="_blank">https://github.com/BigIskander/PlantWatering/tree/main</a>

<h2>Сбор данных и наблюдения за влажностю почвы.</h2>

После того как собрал данное устройство, сбор данных я вел в течении 3 месяцев. Все это время устройство работало автономно (т.е. без внешнего источника питания). Аккумулятор подзаряжался от солнечной панели в дневное время и подразряжался в ночное время. 

В первое время наблюдений, цель была выявить значение уровня влажности почвы при которым лучше всего будет осуществлять полив растения. Поэтому, функция полива устройства была отключена и велось только наблюдение за передаваемыми значения. Полив при этом, когда необходимо, осуществлялся в ручную. Далее исходя из полученных значений (графиков изменения влажности почвы), я определил, что наилучшим решением будет поливать растение когда влажность падает ниже 20%. Таким образом, после первоначальных наблюдений устройство было запрограммировано поливать растение (т.е. наливать 300 мл воды) в случае если влажность почвы ниже 20%. После чего наблюдения продолжились.

Полив растения, за все время наблюдений, осуществлялся только в поддон (горшка с растением).

Непосредственно сбор данных осуществлялся следующим образом: 1) устройство 1 раз в час по WiFi передавало данные на MQTT сервер; 2) программа на компьютере отслеживала сообщения поступающие на MQTT сервер и записывала их в файл.

Далее данные из файла были обработаны и представлены в более удобном для восприятия виде (в виде графиков).

<h2>Результаты наблюдений.</h2>

Ниже представлены графики влажности почвы и напряжения (на аккумуляре), построенные на основе наблюдений за период в 3 месяца (2327 наблюдений). Красными квадратиками обозначено время которое устройство автоматически производило полив.

<img src="/assets/images/posts/2023-09-20-plantwatering/moisture.png" class="zoomable" style="width:calc(max(1753px,100%))" id="image1" alt="График валжности почвы за 3 месяца.">

<img src="/assets/images/posts/2023-09-20-plantwatering/voltage.png" class="zoomable" style="width:calc(max(1752px,100%))" id="image1" alt="График напряжения за 3 месяца.">

Для большей наглядности, ниже представлены графики построенные на осневе наблюдений за перид в 1 неделю.

<img src="/assets/images/posts/2023-09-20-plantwatering/moisture2.png" class="zoomable" style="width:calc(max(1753px,100%))" id="image1" alt="График валжности почвы за неделю.">

<img src="/assets/images/posts/2023-09-20-plantwatering/voltage2.png" class="zoomable" style="width:calc(max(1752px,100%))" id="image1" alt="График напряжения за неделю.">

На графиках можно видеть как меняется влажность почвы и напряжение на аккумуляторе в зависимости от времени дня. В жаркие дни, влажность почвы после полива повышалась достаточно медленно, поэтому в некоторые дни устройство осуществляло полив растения дважды с перерывом в 1 час.

<h2>Про MQTT сервер.</h2>

Для того чтобы получать данные с устройства применялся MQTT сервер. MQTT это протокол используемый для передачи данных между умными устройствами. Для данного проекта я пользовался MQTT сервером предоставляемым сервисом <a href="https://www.wqtt.ru" target="_blank">https://www.wqtt.ru</a>. При желании вы можете использовать любой другой аналогичный сервер или установить свой, локальный MQTT сервер (при наличии соответсвующих навыков). 

На MQTT сервере было создано 3 топика: 
<ul>
<li>voltage - напряжение аккумулятора</li>
<li>moisture - влажность почвы</li>
<li>water - полив (0 - полива небыло, 1 - был осуществлен полив)</li>
</ul>

Особенностью технологии MQTT является то, что MQTT сервер получает сообщения с устройств и передает их дальше на подписанные (на эти сообщения) устройства, при этом на самом сервере эти сообщения обычно не сохраняются. На сервере может храниться только последнее переданное сообщение в топике, если это сообщение передавалось с параметром retain равным true. Поэтому для сбора данных я применял небольшой скрипт написанный на языке программирования python (<a href="https://www.python.org" target="_blank">https://www.python.org</a>) которые в фоновом режиме отслеживал сообщения с MQTT сервера и сохранял их в отдельный файл на компьютере.

Для обработки файла с сохраненными MQTT сообщениями и приведения их в более удобный для восприятия вид была написана небольшая программа работающая внутри jupyter notebook <a href="https://jupyter.org" target="_blank">https://jupyter.org</a>.

Скрип применявшийся для сбора данных, а также небольшая программа, применявшаяся для обработки данных из файла:
<br/><a href="https://github.com/BigIskander/PlantWatering/tree/main/MQTT_Data" target="_blank">https://github.com/BigIskander/PlantWatering/tree/main/MQTT_Data</a>

Для использования этого скрипта (и сбора данных) вам нужно будет в файле <b>credentials.py</b> указать данные для подключения к серверу MQTT.

Для просмотра сообщений с MQTT сервера в реальном времени я использовал программу MQTT Explorer <a href="http://mqtt-explorer.com" target="_blank">http://mqtt-explorer.com</a>. Но к сожалению в этой программе не предусмотрена выгрузка данных и она не умеет сохранять данные, т.е. данные доступны только внутри программы до тех пор пока её не закроешь.

<h2>Электрическая схема.</h2>
Электронные компоненты для сборки устройства:
<ul>
<li>U1 - Wemos D1 mini (микроконтроллер)</li>
<li>U2 - Емкостный датчик влажности почвы V1.2 [Capacitive soil moisture sensor V1.2] (изготовленный на чибе NE555)</li>
<li>U3 - 5 вольтовый мотор (погружной водяной насос)</li>
<li>U4 - небольшая солнечная панель мощьностью 1 ватт</li>
<li>U5 - тактовая кнопка</li>
<li>U6 - индикатора заряда батареи</li>
<li>J1 - модуль зарядки батареи 03962A</li>
<li>J2 - 18650 литий-ионный аккумулятор</li>
<li>R1, R2, R3, R4, R5 - резисторы на 10 килоОмм</li>
<li>C1 - конденсатор с электрическими параметрыми: 16 вольт и 100 микрофарад</li>
<li>T1, T2, T3, T4, T5 - FQP30N06 MOSFET полевые транзисторы</li>
<li>+ плата для прототипирования и провода толщиной 24 AWG (или 0.205 мм<sup>2</sup>)</li>
</ul>


<img src="/assets/images/posts/2023-09-20-plantwatering/CircuitDiagram.png" class="zoomable" style="width:calc(max(300px,80%))" id="image0" />

<h2>Рекомендации по сборке устройства и прошивке микроконтроллера.</h2>

Для удобства сборки лучше оборудовать хорошо освещенное место, чтобы лучше видеть мелкие детали так как часть компонентов небольшие по размеру. Желательно использовать паяльник с регулировкой температуры и хороший припой, так как если во время пайки перегреть электронные компоненты они могут выйти из строя.

Микроконтроллер необходимо прошивать до установки на плату так как если к микроконтроллеру что то подсоединено то прошивка может не произойти. 

Для прошивки микроконтроллера использовалась программа Arduino IDE (<a href="https://www.arduino.cc/en/software" target="_blank">https://www.arduino.cc/en/software</a>).  Программа для микроконтроллера написана на языке программирования <b>C++</b>. Перед прошивкой необходимо будет указать данные для подключения к сети WiFi и к MQTT серверу в файле <b>credentials.hpp</b>. При желании вы можете модифицировать устройство и программу по собственному усмотрению.

Программа для микроконтроллера:
<br/> <a href="https://github.com/BigIskander/PlantWatering/tree/main/PlantWatering" target="_blank">https://github.com/BigIskander/PlantWatering/tree/main/PlantWatering</a>

<h2>Некоторые технические подробности.</h2>

Большая часть электронные компонентов необходимых для сборки покупилась в интернет магазинах: <a href="https://amperka.ru" target="_blank">https://amperka.ru</a> , <a href="https://mcustore.ru" target="_blank">https://mcustore.ru</a> и <a href="https://aliexpress.ru" target="_blank">https://aliexpress.ru</a>. Гибкую трубку для полива покупал на <a href="https://www.ozon.ru" target="_blank">https://www.ozon.ru</a>. Часть из необходимых для сборки деталей уже имелось на руках.

Устройство собрано на базе микроконтроллера <b>Wemos D1 mini</b>. Этот микроконтроллер потребляющий мало электричества. Однако, даже с учетом вышесказанного, аккумулятора не хватит на долго если микроконтроллер все время будет находиться в активном режиме работы. Поэтому, для того чтобы снизить потребление электричества, микроконтроллер был запрограммирован так, что в временной промежуток между измерениями влажности почвы (и поливами) микроконтроллер находится в режиме глубокого сна (т.е. в режиме работы в котором энергопотребление устройства минимально).

Для измерения влажности почвы применяется ёмкостный датчик влажности почвы V1.2 (<b>Capacitive soil moisture sensor V1.2</b>). Это аналоговый датчик, у которого меняется напряжение на выходном пине в зависимости от влажности почвы. К сожалению напряжение на выходном пине так же зависит от напряжения, подаваемого для питание датчика. Для того чтобы учитывать эту особенность нужен был способ измерять напряжение подаваемое для питания датчика.

Сложность заключалась в том, что у выбранного микроконтроллера всего 1 аналогвый пин, который может измерять подаваемое на него напряжение в пределах от 0 до 3.3 вольт, а напряжение требуется измерять с двух источников. К тому же напряжение литий-ионного аккумулятора 18650 (которое тоже требуется измерять), обычно находится в пределах от 3.7 до 4.2 вольт, что превышает порог измерения в 3.3 вольта. Поэтому для последовательного измерения напряжения из двух источников была собрана схема с применением транзисторов, а для измерения напряжения акуумулятора собрана небольшая схема с делителем напряжения.

После того как устройство было собрано производилась калибровка. Я измерял значения получаемые когда датчик сухой 0% влажности и когда датчик погружен в воду 100% влажности, измерения проводил при разных значениях подаваемого напряжения. Затем на основе полученных данных прописал формулу по которой программа (в микроконтроллере) будет вычислять влажность почвы.

Фактически устройство сначала замеряет напряжение источника питания (аккумулятор), затем измеряет напряжение на выходном пине датчика влажности. Далее расчитывает влажность почвы и если влажность почвы меньше 20% устройство наливает 300 мл воды (в поддон растения). После этого устройство по WiFi передает данные на MQTT сервер. После передачи данных устройство уходит в режим глубокого сна на 1 час и через 1 час цикл повторяется.

Решение о том сколько воды устройство будет наливать за один полив принималось с учетом размера поддона растения. Я решил, что в моем случае 300 мл воды будет в самый раз. При желании вы можете поменять эту величину в программе по своему усмотрению. 

Для того чтобы определить как долго должен быть включен насос чтобы налить требуемое количество воды, я сначала измерил какой объем воды насос перекачивает за 10 секунд. Затем, на основе этого, высчитал колличество секунд за которое насос перельет требуемый объем воды. И далее запрограммировал микроконтроллер так, что когда требуется полив, насос включается на нужное колличество секунд и затем выключается.

<h2>Фотографии устройства:</h2>
<img src="/assets/images/posts/2023-09-20-plantwatering/IMG_20230326_100836.jpg" class="zoomable" style="width:calc(max(300px,25%))" id="image1" alt="Снимок устройства.">
<img src="/assets/images/posts/2023-09-20-plantwatering/IMG_20230326_100901.jpg" class="zoomable"
style="width:calc(max(300px,25%))" id="image2" alt="Снимок устройства.">
<img src="/assets/images/posts/2023-09-20-plantwatering/IMG_20230326_101018.jpg" class="zoomable" style="width:calc(max(300px,25%))" id="image3" alt="Снимок устройства.">
<img src="/assets/images/posts/2023-09-20-plantwatering/IMG_20230401_112216.jpg" class="zoomable" style="width:calc(max(300px,25%))" id="image4" alt="Снимок устройства.">
<img src="/assets/images/posts/2023-09-20-plantwatering/IMG_20230612_072729.jpg" class="zoomable" style="width:calc(max(300px,25%))" id="image5" alt="Снимок устройства.">

<p>
Видео демонстрация работы устройства (полив растения):<br/>
<video style="width:calc(min(100%,1280px))" preload="auto" controls>
    <source src="/assets/images/posts/2023-09-20-plantwatering/VID_20230604_092944.mp4" type='video/mp4'/>
    Your browser does not support the video tag.
</video>
</p>

